XÂY DỰNG HỆ THỐNG WEBSITE PHIM TĨNH, ỨNG DỤNG ĐA NỀN TẢNG VÀ ADMIN PANEL CHUYÊN NGHIỆP

1. Tổng quan dự án

Xây dựng một hệ thống hoàn chỉnh bao gồm:

· Website phim tĩnh (static site) với tốc độ tải nhanh, tối ưu SEO, thân thiện với mọi thiết bị (desktop, tablet, mobile, Android TV). Website chính được deploy trên Cloudflare Pages.
· Ứng dụng di động (Android, iOS) và Android TV được đóng gói từ website bằng Capacitor.
· Admin panel chuyên nghiệp (riêng biệt) để quản lý toàn bộ nội dung, quảng cáo, giao diện và cấu hình website. Admin panel deploy trên Vercel.
· Hai Supabase riêng biệt:
  · Supabase User: dành cho người dùng cuối (xác thực, lưu favorites, watch history).
  · Supabase Admin: dành cho quản trị (quản lý cấu hình, quảng cáo, nội dung tĩnh). Admin panel chỉ kết nối với Supabase Admin.
· Dữ liệu phim được lấy từ:
  · API OPhim (cập nhật tự động hàng ngày) – endpoint chi tiết được cung cấp.
  · Google Sheets (cho phim custom, do admin nhập) – với cấu trúc sheet mẫu.
  · TMDB API (bổ sung diễn viên, đạo diễn, từ khóa, ảnh chất lượng cao) – có hướng dẫn lấy API key.
· Hiển thị cả tên tiếng Việt và tên gốc (origin_name) trên toàn bộ giao diện (trang chủ, trang danh mục, trang chi tiết, kết quả tìm kiếm) giống như phong cách Motchill.
· Tất cả cấu hình động (banner, slider, danh mục trang chủ, nguồn server, mã tracking, cài đặt donate, …) được lưu trong Supabase Admin, nhưng khi build sẽ xuất ra file JSON tĩnh phục vụ từ CDN. Website chính chỉ gọi Supabase User cho dữ liệu cá nhân, không gọi Supabase Admin.
· Hỗ trợ Google Analytics và SimpleAnalytics thông qua cấu hình trong Admin Panel, tự động nhúng mã tracking vào website.
· Đồng bộ dữ liệu người dùng thông minh giữa localStorage và Supabase User (delta sync, tiết kiệm băng thông).
· Hệ thống bình luận dùng Twikoo (deploy riêng trên Vercel).
· Tự động hóa bằng GitHub Actions: chạy build hàng ngày và khi có thay đổi từ admin. Chỉ build lại những phần thay đổi (incremental build).
· Tài liệu hướng dẫn đầy đủ trong thư mục docs/, bao gồm cài đặt Supabase (hai project), R2, Google Sheets, Twikoo, Vercel, Cloudflare Pages, GitHub Actions, Capacitor.
· File mẫu nhập liệu: Excel mẫu cho phim custom, JSON mẫu cho cấu hình, .env.example.

2. Công nghệ sử dụng

Thành phần Công nghệ / Thư viện
Build script Node.js (ES modules), node-fetch, fs-extra, sharp, xlsx, googleapis, @supabase/supabase-js, slugify
Frontend (web) HTML5, CSS3, JavaScript thuần, FlexSearch, PWA (manifest + service worker)
Admin Panel React + TypeScript, Ant Design (hoặc Material-UI), React Hook Form + Yup, Vercel Serverless Functions
Database & Auth Supabase (hai project riêng)
Lưu trữ file Cloudflare R2 (ảnh, video, file batch)
Dữ liệu custom Google Sheets (dùng service account)
Bình luận Twikoo (deploy trên Vercel)
Đóng gói app Capacitor (Android, iOS, Android TV)
CI/CD GitHub Actions (workflows tự động)
Hosting web Cloudflare Pages
Hosting admin Vercel

3. Kiến trúc tổng thể

Hệ thống gồm ba phần chính tách biệt:

1. Build Process (Node.js script):
   · Chạy định kỳ (hàng ngày) hoặc khi được kích hoạt từ admin panel.
   · Lấy dữ liệu từ OPhim, Google Sheets, TMDB.
   · Xử lý ảnh (tải về, chuyển WebP, upload R2).
   · Tạo các file tĩnh: movies-light.js, filters.js, actors.js, các file batch chi tiết.
   · Đọc cấu hình từ Supabase Admin, xuất ra các file JSON trong public/data/config/.
   · Commit và push lên repository.
2. Website chính (Public Site):
   · File tĩnh hoàn toàn, phục vụ từ Cloudflare Pages.
   · Tải movies-light.js, filters.js, và các file JSON cấu hình từ CDN.
   · Sử dụng FlexSearch cho tìm kiếm (tìm kiếm trên cả title và origin_name).
   · Kết nối đến Supabase User (project riêng) chỉ để xác thực và đồng bộ dữ liệu cá nhân.
   · Tích hợp Twikoo cho bình luận.
   · Tự động nhúng mã Google Analytics và SimpleAnalytics dựa trên cấu hình từ site-settings.json.
3. Admin Panel (Quản trị):
   · Ứng dụng React riêng, deploy trên Vercel (subdomain admin.yourdomain.com).
   · Kết nối đến Supabase Admin bằng anon key (với RLS bảo vệ).
   · Cho phép quản lý banner, quảng cáo, slider, danh mục trang chủ, nguồn server, cài đặt chung (bao gồm mã tracking, donate, player options), audit log.
   · Sau mỗi thay đổi, gọi webhook để kích hoạt GitHub Actions build lại website (chỉ build phần thay đổi).

4. Yêu cầu chi tiết từng phần

4.1. Script build (build.js) - Node.js

4.1.1. Các API endpoint chi tiết

OPhim (base URL: https://ophim1.com/v1/api)

Mục đích Endpoint Ghi chú
Danh sách phim mới (phân trang) /danh-sach/phim-moi?page={page}&limit=100 Lặp đến khi hết dữ liệu.
Chi tiết phim /phim/{slug} Lấy thông tin đầy đủ, bao gồm episodes.
Danh sách thể loại /the-loai Dùng để đồng bộ slug thể loại.
Danh sách quốc gia /quoc-gia Dùng để đồng bộ slug quốc gia.
Danh sách năm /nam-phat-hanh Dùng để lọc năm.
Peoples (dự phòng) /phim/{slug}/peoples Nếu dùng thay TMDB, nhưng ưu tiên TMDB.
Keywords (dự phòng) /phim/{slug}/keywords Nếu dùng thay TMDB, nhưng ưu tiên TMDB.

TMDB (base URL: https://api.themoviedb.org/3)

Mục đích Endpoint Ghi chú
Credits /{type}/{id}/credits type = 'movie' hoặc 'tv'. Cần API key.
Keywords /{type}/{id}/keywords Trả về keywords.
Chi tiết phim /{type}/{id} Lấy thêm backdrop, poster, overview nếu cần.

Google Sheets API (v4)

· Dùng service account để xác thực.
· Đọc hai sheet movies và episodes từ một Google Sheet có ID cố định (cấu hình trong env).

Supabase Admin (kết nối bằng service role key)

· Đọc bảng server_sources (lấy danh sách nguồn server active).
· Đọc bảng site_settings (lấy các cài đặt chung, bao gồm mã tracking, donate, player options).
· Đọc các bảng ad_banners, homepage_sections, static_pages, donate_settings, ... khi xuất file JSON.

4.1.2. Các bước xử lý chi tiết

1. Thu thập dữ liệu từ OPhim:
   · Gọi /danh-sach/phim-moi lặp qua các trang cho đến khi mảng items rỗng.
   · Với mỗi slug trong danh sách, gọi /phim/{slug} để lấy chi tiết.
   · Lưu vào mảng ophimMovies. Thêm delay (200ms) giữa các request để tránh rate limit.
2. Đọc dữ liệu từ Google Sheets (hoặc Excel dự phòng):
   · Nếu có cấu hình Google Sheets, dùng API để đọc.
   · Fallback: đọc file custom_movies.xlsx trong thư mục gốc.
   · Parse sheet movies: mỗi dòng tạo object phim với ID dạng ext_{timestamp}_{random}. Tạo slug từ title.
   · Bao gồm cả origin_name từ cột origin_name trong sheet.
   · Có thể có cột status (current/upcoming/theater) và showtimes (text) để lưu lịch chiếu.
   · Nếu có tmdb_id, gọi TMDB để lấy thêm cast, director, keywords, ảnh (nếu thiếu).
   · Xử lý ảnh (thumb, poster) nếu có URL: tải về, chuyển WebP, upload R2.
   · Parse sheet episodes: nhóm theo movie_id, với mỗi tập parse cột sources (JSON string) thành mảng các nguồn.
   · Thêm vào mảng customMovies.
3. Làm giàu dữ liệu từ TMDB (cho cả phim OPhim và custom):
   · Nếu phim có tmdb.id (OPhim) hoặc tmdb_id (custom), gọi TMDB để lấy credits và keywords.
   · Bổ sung cast, director, keywords vào dữ liệu phim.
4. Xử lý ảnh:
   · Tải ảnh từ URL (OPhim, TMDB, custom) bằng fetch.
   · Dùng sharp chuyển sang WebP (chất lượng 80%).
   · Upload lên Cloudflare R2 với tên file theo slug (ví dụ: thumbs/phim-abc.webp, posters/phim-abc.webp).
   · Cập nhật lại URL trong dữ liệu.
5. Xác định phim 4K: Dựa vào trường quality (chứa "4k", "uhd", "2160p") → is_4k = true.
6. Xác định phim độc quyền: Với phim custom, dựa vào cột is_exclusive trong Google Sheets (boolean). Mặc định false.
7. Hợp nhất dữ liệu: Gộp ophimMovies và customMovies thành allMovies. Đảm bảo không trùng ID (ID của OPhim là _id, của custom là ext_*).
8. Tạo file movies-light.js (chứa metadata nhẹ cho client):
   ```javascript
   window.moviesLight = allMovies.map(m => ({
     id: m.id,
     title: m.title,
     origin_name: m.origin_name || '',
     slug: m.slug,
     thumb: m.thumb,
     poster: m.poster,
     year: m.year,
     type: m.type, // 'series', 'single', 'tvshows', 'hoathinh', ...
     genre: m.genre,
     country: m.country,
     lang_key: m.lang_key,
     episode_current: m.episode_current,
     quality: m.quality,
     status: m.status || '', // 'current', 'upcoming', 'theater'
     showtimes: m.showtimes || '', // lịch chiếu dạng text
     is_4k: m.is_4k,
     is_exclusive: m.is_exclusive || false,
     chieurap: m.chieurap,
     sub_docquyen: m.sub_docquyen,
     modified: m.modified
   }));
   ```
   Lưu tại public/data/movies-light.js.
9. Tạo filters.js (bản đồ lọc nhanh):
   · genreMap, countryMap, yearMap (object slug → mảng id).
   · typeMap: object với key là các giá trị type (series, single, tvshows, hoathinh).
   · statusMap: object với key là các trạng thái (current, upcoming, theater).
   · quality4kIds, exclusiveIds: mảng id.
   ```javascript
   window.filtersData = {
     genreMap: { ... },
     countryMap: { ... },
     yearMap: { ... },
     typeMap: { ... },
     statusMap: { ... },
     quality4kIds: [ ... ],
     exclusiveIds: [ ... ]
   };
   ```
   Lưu tại public/data/filters.js.
10. Tạo actors.js (cho trang diễn viên):
    · Duyệt allMovies, với mỗi phim có cast (mảng tên), tạo slug từ tên.
    · actorMap[slug] = mảng các id phim.
    · actorNameMap[slug] = tên gốc.
    · Lưu: window.actorsData = { map: actorMap, names: actorNameMap } tại public/data/actors.js.
11. Tạo các file batch chi tiết:
    · Sắp xếp allMovies theo id (string).
    · Chia thành các batch 100 phim (batch 1: id 0-99, batch 2: 100-199, …).
    · Mỗi file batch chứa mảng các object phim đầy đủ (bao gồm episodes, cast, director, keywords, và cả origin_name, status, showtimes).
    · Lưu dạng: window.moviesBatch = [ ... ] trong public/data/batches/batch_{start}_{end}.js.
    · Với phim có số tập > 200, có thể tách episodes thành file riêng episodes/{slug}.js để giảm dung lượng batch.
12. Đọc cấu hình từ Supabase Admin (dùng service role key):
    · Kết nối Supabase Admin.
    · Lấy tất cả bản ghi từ các bảng:
      · server_sources (chỉ lấy is_active = true)
      · ad_banners (lọc theo thời gian, is_active)
      · homepage_sections (sắp xếp theo sort_order)
      · site_settings (lấy tất cả, trả về object key-value) – bao gồm google_analytics_id, simple_analytics_script, donate_settings, player_settings, warning_text, v.v.
      · static_pages (lấy nội dung trang giới thiệu, hướng dẫn app)
      · donate_settings (lấy thông tin donate)
    · Ghi ra các file JSON trong public/data/config/:
      · server-sources.json
      · banners.json
      · homepage-sections.json
      · site-settings.json
      · static-pages.json
      · donate.json
13. Tạo sitemap.xml và robots.txt.
14. Ghi lại trạng thái cập nhật:
    · Lưu file last_modified.json ghi lại modified của mỗi phim từ OPhim và updated_at của phim custom.
    · Lưu file last_build.json ghi lại thời gian build và hash của các file cấu hình.
    · Lần chạy tiếp theo, so sánh thời gian và chỉ tái tạo các file bị ảnh hưởng (incremental build).

4.1.3. Tích hợp GitHub Actions

· Workflow update-data.yml chạy hàng ngày, gọi script build với các biến môi trường.
· Workflow build-on-demand.yml được kích hoạt bằng webhook từ admin panel (có token bảo vệ), chạy incremental build.
· Workflow deploy.yml dùng action cloudflare/pages-action để deploy thư mục public/ lên Cloudflare Pages.

4.2. Website chính (Frontend - thư mục public/)

4.2.1. Cấu trúc thư mục chi tiết

```
public/
├── index.html
├── phim-bo.html
├── phim-le.html
├── shows.html
├── hoat-hinh.html
├── tim-kiem.html
├── dien-vien.html
├── login.html
├── profile.html
├── gioi-thieu.html
├── huong-dan-app.html
├── donate.html
├── phim/
│ └── [slug].html (dùng chung, xử lý bằng JS)
├── the-loai/
│ ├── index.html
│ └── [slug].html
├── quoc-gia/
│ ├── index.html
│ └── [slug].html
├── nam-phat-hanh/
│ ├── index.html
│ └── [year].html
├── danh-sach/
│ ├── index.html
│ ├── phim-4k.html
│ ├── phim-dang-chieu.html
│ ├── phim-sap-chieu.html
│ └── phim-chieu-rap.html
├── css/
│ └── style.css
├── js/
│ ├── main.js
│ ├── category-page.js
│ ├── movie-detail.js
│ ├── search.js
│ ├── dien-vien.js
│ ├── user-sync.js
│ └── player.js
├── data/
│ ├── movies-light.js
│ ├── filters.js
│ ├── actors.js
│ ├── config/
│ │ ├── banners.json
│ │ ├── homepage-sections.json
│ │ ├── server-sources.json
│ │ ├── site-settings.json
│ │ ├── static-pages.json
│ │ └── donate.json
│ └── batches/
├── images/
├── manifest.json
└── sw.js
```

4.2.2. Chức năng chính

Trang chủ (index.html)

· Load file homepage-sections.json để render các section theo thứ tự.
· Mỗi section có thể là:
  · Theo type: source_type = "type", source_value là một trong series, single, tvshows, hoathinh.
  · Theo thể loại: source_type = "genre", source_value là slug thể loại.
  · Theo trạng thái: source_type = "status", source_value là current, upcoming, theater.
· Hiển thị banner từ banners.json theo các vị trí đã định nghĩa.
· Trên mỗi card phim, hiển thị cả title và origin_name. Ví dụ:
  ```html
  <div class="movie-card">
    <img src="...">
    <div class="movie-info">
      <h3 class="title">Còn Ra Thể Thống Gì Nữa</h3>
      <p class="origin-title">How Dare You!?</p>
    </div>
  </div>
  ```

Class CategoryPage (dùng cho các trang danh mục)

· Khởi tạo với tham số:
  · baseFilter: function trả về Set các id phim gốc (ví dụ: từ typeMap.series hoặc statusMap.current).
  · title: tiêu đề trang.
  · itemsPerPage (mặc định 24).
  · gridId, filterContainerId, paginationId.
· Phương thức init():
  · Render tiêu đề.
  · Xây dựng bộ lọc từ filters.js và baseFilter (chỉ hiển thị các năm/thể loại/quốc gia/trạng thái có trong tập cơ sở).
  · Attach sự kiện.
  · Render kết quả trang 1 (mỗi card hiển thị cả origin_name).
· Bộ lọc gồm: năm (dropdown), thể loại (checkbox), quốc gia (checkbox), 4K (checkbox), độc quyền (checkbox).

Các trang danh mục cụ thể

· phim-bo.html: baseFilter = () => new Set(filtersData.typeMap.series)
· phim-le.html: baseFilter = () => new Set(filtersData.typeMap.single)
· shows.html: baseFilter = () => new Set(filtersData.typeMap.tvshows)
· hoat-hinh.html: baseFilter = () => new Set(filtersData.typeMap.hoathinh || [])
· phim-dang-chieu.html: baseFilter = () => new Set(filtersData.statusMap.current || [])
· phim-sap-chieu.html: baseFilter = () => new Set(filtersData.statusMap.upcoming || [])
· phim-chieu-rap.html: baseFilter = () => new Set(filtersData.statusMap.theater || [])
· phim-4k.html: baseFilter = () => new Set(filtersData.quality4kIds)
· Các trang thể loại, quốc gia, năm, diễn viên tương tự.

Trang chi tiết phim (phim/[slug].html)

· Lấy slug từ URL.
· Tải file batch tương ứng (hàm loadBatch dựa trên id).
· Hiển thị thông tin phim:
  · Poster lớn.
  · title và origin_name (hiển thị nổi bật).
  · Năm, thể loại, quốc gia, mô tả, diễn viên (link), đạo diễn, điểm TMDB/IMDB.
  · Nếu status là 'theater' và có showtimes, hiển thị lịch chiếu (dạng text).
· Danh sách tập: dạng lưới. Mỗi tập hiển thị các nguồn server (lấy từ server-sources.json active). Khi click vào nguồn, mở player.
· Nút "Yêu thích" (kiểm tra từ user-sync.js).
· Nút "Tiếp tục xem" (nếu có lịch sử).
· Phần "Phim tương tự": tính toán client-side dựa trên thể loại, quốc gia, năm. Các card phim tương tự cũng hiển thị origin_name.
· Bình luận Twikoo.

Trang tìm kiếm (tim-kiem.html)

· Sử dụng FlexSearch, index trên cả title và origin_name.
· Kết quả hiển thị dạng grid, mỗi card hiển thị cả hai tên.

Trang giới thiệu (gioi-thieu.html)

· Nội dung lấy từ static-pages.json (page_key = 'about').

Trang hướng dẫn cài app (huong-dan-app.html)

· Nội dung lấy từ static-pages.json (page_key = 'app_guide'), hiển thị link tải APK, TestFlight, hướng dẫn chi tiết.

Trang Donate (donate.html)

· Hiển thị mục tiêu donate (target_amount, target_currency), số tiền đã donate (current_amount).
· Liệt kê các phương thức donate được kích hoạt (PayPal, bank, crypto) với thông tin chi tiết.
· Có thể hiển thị thanh tiến trình.

Footer

· Thêm dòng: "Trường Sa, Hoàng Sa là của Việt Nam!"
· Mục "Donate" link đến donate.html.
· Các link nhanh khác.

Xác thực và đồng bộ người dùng (user-sync.js)

· Khởi tạo Supabase User client.
· Lắng nghe sự kiện auth change.
· Cấu trúc localStorage:
  ```javascript
  {
    version: 1,
    lastSync: "2024-...",
    favorites: ["slug1", "slug2"],
    watchHistory: [
      { slug: "slug1", episode: "tap-5", timestamp: 1250, lastWatched: "2024-..." }
    ],
    pendingActions: [] // [{ type, payload, timestamp }]
  }
  ```
· Hàm addFavorite, removeFavorite, updateWatchProgress:
  · Cập nhật localStorage.
  · Thêm action vào pendingActions.
  · Gọi sync() (nếu online) hoặc lên lịch sync sau.
· Hàm sync():
  · Gửi pendingActions lên Supabase (dùng upsert).
  · Sau thành công, xóa actions khỏi pending.
  · Gọi fetchChanges() để lấy các thay đổi từ server từ lastSync.
  · Merge changes vào local (giải quyết xung đột: favorites dùng Set, watchHistory ưu tiên lastWatched mới hơn).
  · Cập nhật lastSync.

Player video (player.js)

· Khi người dùng chọn tập và nguồn, hiển thị player.
· Tùy chọn player engine: Dựa vào site-settings.json (ví dụ: default_player và available_players), hiển thị dropdown cho người dùng chọn player (Plyr, Video.js, JWPlayer...). Nếu chỉ có một player thì ẩn dropdown.
· Cảnh báo dưới player: Kiểm tra trong dữ liệu phim (file batch) có trường warning_enabled (hoặc cấu hình riêng cho từng phim) – nếu true, hiển thị dòng cảnh báo (lấy từ site-settings.json hoặc từ phim). Mặc định dòng cảnh báo là: "Cảnh báo: Phim chứa hình ảnh đường lưỡi bò phi pháp xâm phạm chủ quyền biển đảo Việt Nam."
· Lưu tiến trình xem (gọi updateWatchProgress).

Tích hợp Twikoo (giống như cũ)

PWA (giống như cũ)

4.3. Admin Panel (React - thư mục admin/)

4.3.1. Công nghệ và cấu trúc

· React + TypeScript (Vite).
· Ant Design cho giao diện.
· React Hook Form + Yup.
· Supabase JS client kết nối đến Supabase Admin.
· Vercel Serverless Functions cho các API cần bảo mật (gọi webhook build).

4.3.2. Các trang chức năng chi tiết

Dashboard:

· Thống kê số lượng bản ghi trong các bảng (banner, sections, server sources, ...).
· Audit log gần đây.
· Nút "Build website" (gọi serverless function trigger-build).

Quản lý quảng cáo:

· Banner: CRUD, upload ảnh (gửi lên function để upload R2), chọn vị trí, set thời gian, bật/tắt.
· Pre-roll: CRUD video quảng cáo, set thời gian chờ, trọng số.

Quản lý giao diện:

· Homepage Sections: Danh sách các section, kéo thả sắp xếp. Form thêm/sửa cho phép chọn:
  · Loại nguồn: type, genre, status.
  · Giá trị tương ứng (dropdown động).
  · Số lượng, kiểu hiển thị (grid, slider, list), link "Xem thêm".
· Slider: Quản lý các slide riêng.
· Theme Settings: Chọn màu sắc (color picker), xem trước.

Quản lý nguồn server:

· CRUD các nguồn server (tên, slug, thứ tự, active).

Quản lý phim custom:

· CRUD phim custom (tương tự Google Sheets, nhưng lưu vào Supabase Admin thay vì Google Sheets nếu muốn). Tuy nhiên, vẫn ưu tiên dùng Google Sheets cho dễ nhập liệu hàng loạt.

Quản lý trạng thái phim:

· Cho phép gán status và showtimes cho từng phim (cả OPhim và custom) qua một form riêng hoặc trong form sửa phim.

Quản lý Donate:

· Trang DonateSettings:
  · Nhập mục tiêu donate (số tiền, loại tiền tệ).
  · Nhập tổng số tiền đã donate (có thể cập nhật thủ công).
  · Quản lý các phương thức donate: PayPal (link), Bank (thông tin JSON), Crypto (địa chỉ ví).
  · Kích hoạt/bỏ kích hoạt từng phương thức.
  · Lưu vào bảng donate_settings.

Quản lý nội dung tĩnh:

· Trang StaticPages cho phép chỉnh sửa nội dung của:
  · Trang giới thiệu (dùng WYSIWYG).
  · Trang hướng dẫn cài app (dùng WYSIWYG + các trường nhập link APK, TestFlight).
· Lưu vào bảng static_pages.

Cài đặt Player & Cảnh báo:

· Trong GeneralSettings, thêm các mục:
  · Danh sách player có sẵn (dạng key-value) và cho phép chọn player mặc định.
  · Checkbox "Hiển thị cảnh báo dưới player" (bật/tắt toàn cục, nhưng cảnh báo thực tế chỉ hiển thị nếu phim được bật riêng? – Cần làm rõ: có hai cấp độ: toàn cục và trên từng phim. Tốt nhất là cấu hình trên từng phim trong phần sửa phim (một checkbox "Hiển thị cảnh báo").)
  · Nội dung cảnh báo có thể chỉnh sửa (mặc định như trên).

Cài đặt chung:

· Thông tin website, logo, favicon.
· Mã nhúng tracking (Google Analytics ID, SimpleAnalytics script).
· Liên kết mạng xã hội.
· Nội dung footer (WYSIWYG).
· TMDB Attribution toggle.
· Cấu hình build (lịch sử build, nút build).

Nhật ký (Audit Logs):

· Hiển thị bảng log với các cột: thời gian, user, hành động, đối tượng, chi tiết.

4.3.3. Tích hợp webhook build

· Serverless function trigger-build.ts nhận POST request, kiểm tra token, dùng GitHub API để trigger workflow build-on-demand.yml.

4.4. Supabase (hai project riêng biệt)

4.4.1. Supabase User Project

Auth: Cấu hình email/password, Google OAuth.

Tables:

```sql
profiles (id, email, full_name, avatar_url, created_at)
favorites (id, user_uid, movie_slug, created_at) UNIQUE(user_uid, movie_slug)
watch_history (id, user_uid, movie_slug, episode, timestamp, last_watched) UNIQUE(user_uid, movie_slug)
user_changes (id, user_uid, change_type, item_key, new_value, created_at)
```

RLS: Policies đảm bảo user chỉ truy cập dữ liệu của mình.

4.4.2. Supabase Admin Project

Auth: Email/password + MFA, custom claim role = 'admin'.

Tables:

```sql
ad_banners (id, title, image_url, link_url, html_code, position, start_date, end_date, is_active, priority, created_at, updated_at)
ad_preroll (id, name, video_url, image_url, duration, skip_after, weight, is_active, created_at)
homepage_sections (id, title, display_type, source_type, source_value, filter_config, manual_movies, limit_count, more_link, sort_order, is_active, created_at, updated_at)
server_sources (id, name, slug, is_active, sort_order, created_at)
site_settings (key, value, updated_at) -- lưu các cài đặt chung
static_pages (page_key primary key, content text, updated_at)
donate_settings (id, target_amount, target_currency, current_amount, paypal_link, bank_info jsonb, crypto_addresses jsonb, updated_at)
player_settings (key, value jsonb, updated_at) -- lưu danh sách player, player mặc định, cảnh báo toàn cục, text cảnh báo
audit_logs (id, user_id, action, entity_type, entity_id, old_data, new_data, ip_address, created_at)
-- Có thể thêm bảng custom_movies nếu muốn lưu trực tiếp thay Google Sheets, nhưng ưu tiên Google Sheets.
```

RLS: Policy USING (auth.jwt() ->> 'role' = 'admin') cho tất cả bảng.

4.5. Google Sheets cho phim custom

Sheet movies (các cột, bao gồm origin_name, status, showtimes):

| id | title | origin_name | type | year | genre | country | language | description | content | thumb_url | poster_url | tmdb_id | imdb_id | director | cast | tags | quality | status | showtimes | is_exclusive |

Sheet episodes như cũ.

File mẫu custom_movies_template.xlsx được cung cấp trong docs/templates/.

4.6. Twikoo (bình luận)

· Deploy Twikoo lên Vercel, cấu hình MongoDB.
· Nhúng vào trang chi tiết phim.

4.7. Đóng gói ứng dụng với Capacitor

· Copy public/ vào app/www/.
· Cấu hình Capacitor, thêm Android, iOS.
· Hỗ trợ Android TV (focus, key event).
· Hướng dẫn build và phân phối (TestFlight cho iOS).

4.8. Tự động hóa với GitHub Actions

Workflow update-data.yml (chạy hàng ngày):

· Checkout, cài Node, chạy build.js với secrets.
· Commit và push nếu có thay đổi.

Workflow build-on-demand.yml (kích hoạt bằng webhook):

· Trigger bằng repository_dispatch, chạy build với chế độ incremental.

Workflow deploy.yml:

· Dùng action cloudflare/pages-action để deploy thư mục public/ lên Cloudflare Pages.

5. Cấu trúc thư mục tổng thể

```
project-root/
├── .github/
│ └── workflows/
│ ├── update-data.yml
│ ├── build-on-demand.yml
│ └── deploy.yml
├── scripts/
│ └── build.js
├── public/ # Website chính (deploy lên Cloudflare Pages)
│ ├── index.html
│ ├── gioi-thieu.html
│ ├── huong-dan-app.html
│ ├── donate.html
│ ├── phim-bo.html
│ ├── phim-le.html
│ ├── shows.html
│ ├── hoat-hinh.html
│ ├── phim-dang-chieu.html
│ ├── phim-sap-chieu.html
│ ├── phim-chieu-rap.html
│ ├── phim-4k.html
│ ├── tim-kiem.html
│ ├── dien-vien.html
│ ├── login.html
│ ├── profile.html
│ ├── phim/
│ │ └── [slug].html
│ ├── the-loai/
│ ├── quoc-gia/
│ ├── nam-phat-hanh/
│ ├── danh-sach/
│ ├── css/
│ ├── js/
│ ├── data/
│ │ ├── movies-light.js
│ │ ├── filters.js
│ │ ├── actors.js
│ │ ├── config/
│ │ └── batches/
│ ├── images/
│ ├── manifest.json
│ └── sw.js
├── admin/ # Admin panel (React, deploy Vercel)
│ ├── src/
│ ├── functions/
│ ├── package.json
│ └── ...
├── app/ # Capacitor app
├── docs/ # Tài liệu hướng dẫn
│ ├── supabase/
│ ├── vercel/
│ ├── cloudflare-pages/
│ ├── r2/
│ ├── google-sheets/
│ ├── twikoo/
│ ├── github-actions/
│ ├── capacitor/
│ └── templates/
│ ├── custom_movies_template.xlsx
│ ├── .env.example
│ └── config-json-examples/
├── .env.example
├── package.json
└── README.md
```

6. Yêu cầu về hiệu năng, SEO và trải nghiệm

· Incremental build đảm bảo thời gian build nhanh.
· Ảnh: WebP, lazy loading.
· SEO:
  · Mỗi trang có title, meta description động (cập nhật bằng JS).
  · Sitemap.xml, robots.txt.
  · TMDB attribution ở footer.
  · Cấu trúc URL thân thiện (slug).
· Hiển thị tên phim: Luôn hiển thị cả title và origin_name.
· TV Experience: Focus visible, xử lý keydown, player hỗ trợ remote.
· Donate: Có thể tắt quảng cáo nếu đạt mục tiêu donate (tính năng này có thể phát triển sau, nhưng cần lưu ý).

7. Đầu ra mong đợi từ Cursor

Hãy tạo toàn bộ mã nguồn cho dự án, bao gồm:

· Tất cả các file trong cấu trúc thư mục trên.
· File .env.example với danh sách biến môi trường.
· File SQL mẫu cho Supabase (hai project) trong docs/supabase/.
· File Excel mẫu custom_movies_template.xlsx (đã có cột origin_name, status, showtimes).
· File JSON mẫu cho cấu hình trong docs/templates/config-json-examples/.
· Hướng dẫn chi tiết bằng Markdown trong từng thư mục con của docs/ (mỗi hướng dẫn rõ ràng, từng bước).
· Mã nguồn phải sẵn sàng để chạy ngay sau khi clone, cài đặt dependencies (npm install ở thư mục gốc và admin/) và cấu hình biến môi trường theo .env.example.

---
